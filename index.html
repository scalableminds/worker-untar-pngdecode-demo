<!DOCTYPE html>
<html>
  <head>
    <title>Worker Demo</title>

  </head>
  <body>

    <canvas id="test" width="1000" height="1000"></canvas>

    <script src="bitjs/io.js"></script>
    <script src="bitjs/untar.js"></script>
    <script src="lib/deflate.min.js"></script>
    <script src="lib/inflate.min.js"></script>
    <script src="lib/crc32.js"></script>
    <script src="lib/png_decoder.js"></script>
    <script src="lib/png_encoder.js"></script>
    <script>

      var timeStart = Date.now();
      var URL = this.webkitURL ? this.webkitURL : this.URL;

      function arrayIsEqual(a, b) {
        if (a.length != b.length) return false;

        for (var i = 0; i < a.length; i++)
          if (a[i] != b[i]) return false;

        return true;
      }

      var worker = new Worker("worker.js");

      worker.postMessage("output.tar");
      worker.onmessage = function (event) {

        var canvas = document.getElementById("test");
        var context = canvas.getContext("2d");

        var img = new Image();
        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          context.drawImage(img, 0, 0);

          var data = context.getImageData(0, 0, img.width, img.height);

          console.profile("pngencode");
          var blobParts = pngencode(data);
          var blob = new Blob([blobParts], { type : "image/png" });
          var blobUrl = URL.createObjectURL(blob);

          console.log(arrayIsEqual(pngdecode(blobParts).data, data.data));

          var img2 = new Image();
          img2.onload = function () {
            console.profileEnd("pngencode");
            context.fillStyle = "rgba(122,122,12,.5);";
            context.fillRect(0, 0, 100, 100);
            context.drawImage(img2, 0, 0);
          }
          console.log(img2.src = blobUrl);

          console.log("draw", Date.now() - timeStart);
        }
        img.src = URL.createObjectURL(event.data.blob);

        worker.onmessage = function () {};

      }

    </script>
    
  </body>
</html>